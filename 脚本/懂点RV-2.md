## 懂点RV - 4.1

关于模拟器的源码结构分析



先对模拟器的运行层次进行介绍，然后再去介绍重要的代码文件

- disasm 反汇编，实际内容是根据指令码组装反汇编字符串，应该是为了debug和显示指令流
- fdt 扁平设备树，猜测设备树是它用来实现SOC配置的方式
- fesvr 源于Frontend Server的缩写。它包含一些与riscv无关的构成模拟器的组件，SOC组件的一些基础抽象，以及模拟器的运行管理。它实现了一个模拟器的大框架。
- riscv 其中的insns目录中是riscv指令集的实现，剩下的是SOC的具体实现
- softfloat 浮点库，来自于IEEE Floating-Point Arithmetic Packag
- spike-main 模拟器程序入口，用户的命令参数



### 文案 - 1

你是一名对计算机技术颇有自信的平凡大学生，这天你正在思考人生的意义

此时对面走过来一位姑娘，“听说学长学的是计算机，肯定很厉害啊”

你熟练的切屏到 leetcode 的 Accept 界面，谦虚的表达也就一般

同时你的嘴角微微飘起，飞快的敲起了键盘，屏幕上出现了熟悉的 `Hello RISCV64` 

你心想，可没有多少人会这个，但是在展示的同时，你有没有思考过，这行字符是怎么打印出来的呢



经过前面的学习，我们知道，`qemu` `spike` 之类的程序可以通过软件模拟硬件的执行，让程序以为它运行在 riscv-64 平台的电脑上

一个模拟器遵循模块化开发，以 spike 为例

它需要一个文件夹来完成 riscv64 指令集的功能，比如加法运算，加载立即数，这些功能离不开内存和寄存器的支持，所以也需要模拟外部设备的实现

当用户更进一步使用，可能需要提供一些定制化需求，这个时候提供模拟器的参数定义



spike 的核心文件功能在上面列出，



不知不觉又学习了这么多，下一次在屏幕上输出可以不止 `Hello RISCV64` 了！



### 文案 - 2

既然已经知道模拟器是什么，那么下一步自然是了解模拟器是怎么实现的

大型项目就像积木一样，是一块一块拼起来的，模拟器也不例外

我们拿 spike 为例，

它需要一个文件夹来完成 riscv64 指令集的功能，比如加法运算，加载立即数，这些功能离不开内存和寄存器的支持，所以也需要模拟外部设备的实现

当用户更进一步使用，可能需要提供一些定制化需求，这个时候提供模拟器的参数定义



当我们了解到这些，就可以胸有成竹的打开 spike 项目的 github 界面，

其中核心文件有 6 个





## GPT

扁平设备树（Flattened Device Tree，FDT）是一种描述硬件设备配置的数据结构，常用于嵌入式系统和虚拟化环境中，例如 QEMU 模拟器。FDT 的主要功能是提供一种标准化的方法来描述系统的硬件组件及其关系，使得操作系统能够在启动时动态配置和识别硬件设备。

#### 扁平设备树的结构

扁平设备树采用一种层次化的结构，类似于文件系统的目录树。它由以下几个部分组成：

1. **根节点**：设备树的起始节点，代表整个设备树的根。
2. **子节点**：每个节点可以有多个子节点，表示系统中的具体硬件组件。
3. **属性**：每个节点可以有多个属性，每个属性由名称和值组成，用于描述节点的具体信息。

#### 设备树的描述

设备树通常使用设备树源（Device Tree Source，DTS）文件来描述，然后通过设备树编译器（Device Tree Compiler，DTC）将其编译成设备树二进制（Device Tree Blob，DTB）格式。在 DTS 文件中，设备树的描述类似于以下结构：

```dts
/dts-v1/;

/ {
    compatible = "qemu,arm-virt";
    #address-cells = <2>;
    #size-cells = <2>;
    model = "QEMU ARM Virtual Machine";

    memory {
        device_type = "memory";
        reg = <0x00000000 0x80000000>;  // 起始地址和大小
    };

    cpus {
        #address-cells = <1>;
        #size-cells = <0>;
        cpu@0 {
            device_type = "cpu";
            compatible = "arm,cortex-a53";
            reg = <0x0>;
        };
    };

    soc {
        compatible = "simple-bus";
        #address-cells = <2>;
        #size-cells = <2>;
        ranges;

        uart@1c090000 {
            compatible = "ns16550a";
            reg = <0x1c090000 0x1000>;
            interrupt-parent = <&intc>;
            interrupts = <0 5 4>;
        };
    };
};
```

#### 主要组件

1. **compatible 属性**：表示设备或节点的兼容性信息，操作系统根据此属性来加载相应的驱动程序。
2. **reg 属性**：描述设备的寄存器地址和大小。
3. **interrupts 属性**：描述设备的中断信息。

#### 扁平设备树在模拟器中的作用

在 QEMU 等模拟器中，FDT 被广泛用于描述虚拟硬件配置，使得虚拟机操作系统能够识别和配置模拟的硬件设备。具体作用包括：

1. **硬件配置描述**：FDT 提供了一种灵活的方法来描述虚拟机中的硬件配置，包括 CPU、内存、I/O 设备等。
2. **操作系统启动**：虚拟机启动时，操作系统读取 FDT 来动态配置硬件设备，避免了硬编码的硬件配置。
3. **硬件扩展**：通过修改 FDT，可以方便地添加或移除虚拟硬件设备，便于模拟器的扩展和测试。

#### 扁平设备树的优点

1. **标准化描述**：FDT 提供了一种标准化的方法来描述硬件配置，便于不同操作系统和平台的兼容。
2. **灵活性**：FDT 结构灵活，易于扩展和修改，适用于各种复杂的硬件配置。
3. **动态配置**：操作系统在启动时可以动态读取 FDT 配置，避免了硬件配置的硬编码。

#### 总结

扁平设备树是一种描述硬件设备配置的标准化数据结构，广泛用于嵌入式系统和虚拟化环境中。它通过层次化的节点和属性结构，提供了灵活的硬件配置描述方法，使得操作系统能够在启动时动态识别和配置硬件设备。在模拟器中，FDT 可以有效地描述虚拟硬件配置，支持灵活的硬件扩展和测试。